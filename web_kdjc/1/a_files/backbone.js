(function(){var i=this,b=i.Backbone,f=Array.prototype.slice,h=Array.prototype.splice,e;e="undefined"!==typeof exports?exports:i.Backbone={};e.VERSION="0.9.2";var g=i._;!g&&"undefined"!==typeof require&&(g=require("underscore"));var k=i.jQuery||i.Zepto||i.ender;e.setDomLibrary=function(a){k=a};e.noConflict=function(){i.Backbone=b;return this};e.emulateHTTP=!1;e.emulateJSON=!1;var m=/\s+/,l=e.Events={on:function(a,c,d){var j,q,b,g,e;if(!c)return this;a=a.split(m);for(j=this._callbacks||(this._callbacks=
{});q=a.shift();)b=(e=j[q])?e.tail:{},b.next=g={},b.context=d,b.callback=c,j[q]={tail:g,next:e?e.next:b};return this},off:function(a,c,d){var j,b,e,f,h,i;if(b=this._callbacks){if(!a&&!c&&!d)return delete this._callbacks,this;for(a=a?a.split(m):g.keys(b);j=a.shift();)if(e=b[j],delete b[j],e&&(c||d))for(f=e.tail;(e=e.next)!==f;)if(h=e.callback,i=e.context,c&&h!==c||d&&i!==d)this.on(j,h,i);return this}},trigger:function(a){var c,d,j,b,g,e;if(!(j=this._callbacks))return this;g=j.all;a=a.split(m);for(e=
f.call(arguments,1);c=a.shift();){if(d=j[c])for(b=d.tail;(d=d.next)!==b;)d.callback.apply(d.context||this,e);if(d=g){b=d.tail;for(c=[c].concat(e);(d=d.next)!==b;)d.callback.apply(d.context||this,c)}}return this}};l.bind=l.on;l.unbind=l.off;var p=e.Model=function(a,c){var d;a||(a={});c&&c.parse&&(a=this.parse(a));if(d=o(this,"defaults"))a=g.extend({},d,a);if(c&&c.collection)this.collection=c.collection;this.attributes={};this._escapedAttributes={};this.cid=g.uniqueId("c");this.changed={};this._silent=
{};this._pending={};this.set(a,{silent:!0});this.changed={};this._silent={};this._pending={};this._previousAttributes=g.clone(this.attributes);this.initialize.apply(this,arguments)};g.extend(p.prototype,l,{changed:null,_silent:null,_pending:null,idAttribute:"id",initialize:function(){},toJSON:function(){return g.clone(this.attributes)},get:function(a){return this.attributes[a]},escape:function(a){var c;if(c=this._escapedAttributes[a])return c;c=this.get(a);return this._escapedAttributes[a]=g.escape(null==
c?"":""+c)},has:function(a){return null!=this.get(a)},set:function(a,c,d){var j,b;g.isObject(a)||null==a?(j=a,d=c):(j={},j[a]=c);d||(d={});if(!j)return this;if(j instanceof p)j=j.attributes;if(d.unset)for(b in j)j[b]=void 0;if(!this._validate(j,d))return!1;if(this.idAttribute in j)this.id=j[this.idAttribute];var c=d.changes={},e=this.attributes,f=this._escapedAttributes,h=this._previousAttributes||{};for(b in j){a=j[b];if(!g.isEqual(e[b],a)||d.unset&&g.has(e,b))delete f[b],(d.silent?this._silent:
c)[b]=!0;d.unset?delete e[b]:e[b]=a;!g.isEqual(h[b],a)||g.has(e,b)!=g.has(h,b)?(this.changed[b]=a,d.silent||(this._pending[b]=!0)):(delete this.changed[b],delete this._pending[b])}d.silent||this.change(d);return this},unset:function(a,c){(c||(c={})).unset=!0;return this.set(a,null,c)},clear:function(a){(a||(a={})).unset=!0;return this.set(g.clone(this.attributes),a)},fetch:function(a){var a=a?g.clone(a):{},c=this,d=a.success;a.success=function(b,e,g){if(!c.set(c.parse(b,g),a))return!1;d&&d(c,b)};
a.error=e.wrapError(a.error,c,a);return(this.sync||e.sync).call(this,"read",this,a)},save:function(a,c,d){var b,f;g.isObject(a)||null==a?(b=a,d=c):(b={},b[a]=c);d=d?g.clone(d):{};if(d.wait){if(!this._validate(b,d))return!1;f=g.clone(this.attributes)}a=g.extend({},d,{silent:!0});if(b&&!this.set(b,d.wait?a:d))return!1;var h=this,i=d.success;d.success=function(a,c,e){c=h.parse(a,e);d.wait&&(delete d.wait,c=g.extend(b||{},c));if(!h.set(c,d))return!1;i?i(h,a):h.trigger("sync",h,a,d)};d.error=e.wrapError(d.error,
h,d);c=this.isNew()?"create":"update";c=(this.sync||e.sync).call(this,c,this,d);d.wait&&this.set(f,a);return c},destroy:function(a){var a=a?g.clone(a):{},c=this,d=a.success,b=function(){c.trigger("destroy",c,c.collection,a)};if(this.isNew())return b(),!1;a.success=function(e){a.wait&&b();d?d(c,e):c.trigger("sync",c,e,a)};a.error=e.wrapError(a.error,c,a);var f=(this.sync||e.sync).call(this,"delete",this,a);a.wait||b();return f},url:function(){var a=o(this,"urlRoot")||o(this.collection,"url")||t();
return this.isNew()?a:a+("/"==a.charAt(a.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(a){return a},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return null==this.id},change:function(a){a||(a={});var c=this._changing;this._changing=!0;for(var d in this._silent)this._pending[d]=!0;var b=g.extend({},a.changes,this._silent);this._silent={};for(d in b)this.trigger("change:"+d,this,this.get(d),a);if(c)return this;for(;!g.isEmpty(this._pending);){this._pending=
{};this.trigger("change",this,a);for(d in this.changed)!this._pending[d]&&!this._silent[d]&&delete this.changed[d];this._previousAttributes=g.clone(this.attributes)}this._changing=!1;return this},hasChanged:function(a){return!arguments.length?!g.isEmpty(this.changed):g.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?g.clone(this.changed):!1;var c,d=!1,b=this._previousAttributes,e;for(e in a)if(!g.isEqual(b[e],c=a[e]))(d||(d={}))[e]=c;return d},previous:function(a){return!arguments.length||
!this._previousAttributes?null:this._previousAttributes[a]},previousAttributes:function(){return g.clone(this._previousAttributes)},isValid:function(){return!this.validate(this.attributes)},_validate:function(a,c){if(c.silent||!this.validate)return!0;var a=g.extend({},this.attributes,a),d=this.validate(a,c);if(!d)return!0;c&&c.error?c.error(this,d,c):this.trigger("error",this,d,c);return!1}});var r=e.Collection=function(a,c){c||(c={});if(c.model)this.model=c.model;if(c.comparator)this.comparator=
c.comparator;this._reset();this.initialize.apply(this,arguments);a&&this.reset(a,{silent:!0,parse:c.parse})};g.extend(r.prototype,l,{model:p,initialize:function(){},toJSON:function(a){return this.map(function(c){return c.toJSON(a)})},add:function(a,c){var d,b,e,f,i,k={},l={},m=[];c||(c={});a=g.isArray(a)?a.slice():[a];for(d=0,b=a.length;d<b;d++){if(!(e=a[d]=this._prepareModel(a[d],c)))throw Error("Can't add an invalid model to a collection");f=e.cid;i=e.id;k[f]||this._byCid[f]||null!=i&&(l[i]||this._byId[i])?
m.push(d):k[f]=l[i]=e}for(d=m.length;d--;)a.splice(m[d],1);for(d=0,b=a.length;d<b;d++)(e=a[d]).on("all",this._onModelEvent,this),this._byCid[e.cid]=e,null!=e.id&&(this._byId[e.id]=e);this.length+=b;h.apply(this.models,[null!=c.at?c.at:this.models.length,0].concat(a));this.comparator&&this.sort({silent:!0});if(c.silent)return this;for(d=0,b=this.models.length;d<b;d++)if(k[(e=this.models[d]).cid])c.index=d,e.trigger("add",e,this,c);return this},remove:function(a,c){var d,b,e,f;c||(c={});a=g.isArray(a)?
a.slice():[a];for(d=0,b=a.length;d<b;d++)if(f=this.getByCid(a[d])||this.get(a[d])){delete this._byId[f.id];delete this._byCid[f.cid];e=this.indexOf(f);this.models.splice(e,1);this.length--;if(!c.silent)c.index=e,f.trigger("remove",f,this,c);this._removeReference(f)}return this},push:function(a,c){a=this._prepareModel(a,c);this.add(a,c);return a},pop:function(a){var c=this.at(this.length-1);this.remove(c,a);return c},unshift:function(a,c){a=this._prepareModel(a,c);this.add(a,g.extend({at:0},c));return a},
shift:function(a){var c=this.at(0);this.remove(c,a);return c},get:function(a){return null==a?void 0:this._byId[null!=a.id?a.id:a]},getByCid:function(a){return a&&this._byCid[a.cid||a]},at:function(a){return this.models[a]},where:function(a){return g.isEmpty(a)?[]:this.filter(function(c){for(var d in a)if(a[d]!==c.get(d))return!1;return!0})},sort:function(a){a||(a={});if(!this.comparator)throw Error("Cannot sort a set without a comparator");var c=g.bind(this.comparator,this);1==this.comparator.length?
this.models=this.sortBy(c):this.models.sort(c);a.silent||this.trigger("reset",this,a);return this},pluck:function(a){return g.map(this.models,function(c){return c.get(a)})},reset:function(a,c){a||(a=[]);c||(c={});for(var d=0,b=this.models.length;d<b;d++)this._removeReference(this.models[d]);this._reset();this.add(a,g.extend({silent:!0},c));c.silent||this.trigger("reset",this,c);return this},fetch:function(a){a=a?g.clone(a):{};if(void 0===a.parse)a.parse=!0;var c=this,d=a.success;a.success=function(b,
e,f){c[a.add?"add":"reset"](c.parse(b,f),a);d&&d(c,b)};a.error=e.wrapError(a.error,c,a);return(this.sync||e.sync).call(this,"read",this,a)},create:function(a,c){var d=this,c=c?g.clone(c):{},a=this._prepareModel(a,c);if(!a)return!1;c.wait||d.add(a,c);var b=c.success;c.success=function(e,f){c.wait&&d.add(e,c);b?b(e,f):e.trigger("sync",a,f,c)};a.save(null,c);return a},parse:function(a){return a},chain:function(){return g(this.models).chain()},_reset:function(){this.length=0;this.models=[];this._byId=
{};this._byCid={}},_prepareModel:function(a,c){c||(c={});if(a instanceof p){if(!a.collection)a.collection=this}else{var d;c.collection=this;a=new this.model(a,c);a._validate(a.attributes,c)||(a=!1)}return a},_removeReference:function(a){this==a.collection&&delete a.collection;a.off("all",this._onModelEvent,this)},_onModelEvent:function(a,c,d,b){("add"==a||"remove"==a)&&d!=this||("destroy"==a&&this.remove(c,b),c&&a==="change:"+c.idAttribute&&(delete this._byId[c.previous(c.idAttribute)],this._byId[c.id]=
c),this.trigger.apply(this,arguments))}});g.each("forEach,each,map,reduce,reduceRight,find,detect,filter,select,reject,every,all,some,any,include,contains,invoke,max,min,sortBy,sortedIndex,toArray,size,first,initial,rest,last,without,indexOf,shuffle,lastIndexOf,isEmpty,groupBy".split(","),function(a){r.prototype[a]=function(){return g[a].apply(g,[this.models].concat(g.toArray(arguments)))}});var u=e.Router=function(a){a||(a={});if(a.routes)this.routes=a.routes;this._bindRoutes();this.initialize.apply(this,
arguments)},y=/:\w+/g,z=/\*\w+/g,A=/[-[\]{}()+?.,\\^$|#\s]/g;g.extend(u.prototype,l,{initialize:function(){},route:function(a,c,d){e.history||(e.history=new n);g.isRegExp(a)||(a=this._routeToRegExp(a));d||(d=this[c]);e.history.route(a,g.bind(function(b){b=this._extractParameters(a,b);d&&d.apply(this,b);this.trigger.apply(this,["route:"+c].concat(b));e.history.trigger("route",this,c,b)},this));return this},navigate:function(a,c){e.history.navigate(a,c)},_bindRoutes:function(){if(this.routes){var a=
[],c;for(c in this.routes)a.unshift([c,this.routes[c]]);c=0;for(var d=a.length;c<d;c++)this.route(a[c][0],a[c][1],this[a[c][1]])}},_routeToRegExp:function(a){a=a.replace(A,"\\$&").replace(y,"([^/]+)").replace(z,"(.*?)");return RegExp("^"+a+"$")},_extractParameters:function(a,c){return a.exec(c).slice(1)}});var n=e.History=function(){this.handlers=[];g.bindAll(this,"checkUrl")},s=/^[#\/]/,B=/msie [\w.]+/;n.started=!1;g.extend(n.prototype,l,{interval:50,getHash:function(a){return(a=(a?a.location:window.location).href.match(/#(.*)$/))?
a[1]:""},getFragment:function(a,c){if(null==a)if(this._hasPushState||c){var a=window.location.pathname,d=window.location.search;d&&(a+=d)}else a=this.getHash();a.indexOf(this.options.root)||(a=a.substr(this.options.root.length));return a.replace(s,"")},start:function(a){if(n.started)throw Error("Backbone.history has already been started");n.started=!0;this.options=g.extend({},{root:"/"},this.options,a);this._wantsHashChange=!1!==this.options.hashChange;this._wantsPushState=!!this.options.pushState;
this._hasPushState=!(!this.options.pushState||!window.history||!window.history.pushState);var a=this.getFragment(),c=document.documentMode;if(c=B.exec(navigator.userAgent.toLowerCase())&&(!c||7>=c))this.iframe=k('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(a);if(this._hasPushState)k(window).bind("popstate",this.checkUrl);else if(this._wantsHashChange&&"onhashchange"in window&&!c)k(window).bind("hashchange",this.checkUrl);else if(this._wantsHashChange)this._checkUrlInterval=
setInterval(this.checkUrl,this.interval);this.fragment=a;a=window.location;c=a.pathname==this.options.root;if(this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!c)return this.fragment=this.getFragment(null,!0),window.location.replace(this.options.root+"#"+this.fragment),!0;if(this._wantsPushState&&this._hasPushState&&c&&a.hash)this.fragment=this.getHash().replace(s,""),window.history.replaceState({},document.title,a.protocol+"//"+a.host+this.options.root+this.fragment);if(!this.options.silent)return this.loadUrl()},
stop:function(){k(window).unbind("popstate",this.checkUrl).unbind("hashchange",this.checkUrl);clearInterval(this._checkUrlInterval);n.started=!1},route:function(a,c){this.handlers.unshift({route:a,callback:c})},checkUrl:function(){var a=this.getFragment();a==this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe)));if(a==this.fragment)return!1;this.iframe&&this.navigate(a);this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(a){var c=this.fragment=this.getFragment(a);return g.any(this.handlers,
function(a){if(a.route.test(c))return a.callback(c),!0})},navigate:function(a,c){if(!n.started)return!1;if(!c||!0===c)c={trigger:c};var d=(a||"").replace(s,"");if(this.fragment!=d)this._hasPushState?(0!=d.indexOf(this.options.root)&&(d=this.options.root+d),this.fragment=d,window.history[c.replace?"replaceState":"pushState"]({},document.title,d)):this._wantsHashChange?(this.fragment=d,this._updateHash(window.location,d,c.replace),this.iframe&&d!=this.getFragment(this.getHash(this.iframe))&&(c.replace||
this.iframe.document.open().close(),this._updateHash(this.iframe.location,d,c.replace))):window.location.assign(this.options.root+a),c.trigger&&this.loadUrl(a)},_updateHash:function(a,c,d){d?a.replace(a.toString().replace(/(javascript:|#).*$/,"")+"#"+c):a.hash=c}});var v=e.View=function(a){this.cid=g.uniqueId("view");this._configure(a||{});this._ensureElement();this.initialize.apply(this,arguments);this.delegateEvents()},C=/^(\S+)\s*(.*)$/,w="model,collection,el,id,attributes,className,tagName".split(",");
g.extend(v.prototype,l,{tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},remove:function(){this.$el.remove();return this},make:function(a,c,d){a=document.createElement(a);c&&k(a).attr(c);d&&k(a).html(d);return a},setElement:function(a,c){this.$el&&this.undelegateEvents();this.$el=a instanceof k?a:k(a);this.el=this.$el[0];!1!==c&&this.delegateEvents();return this},delegateEvents:function(a){if(a||(a=o(this,"events"))){this.undelegateEvents();
for(var c in a){var d=a[c];g.isFunction(d)||(d=this[a[c]]);if(!d)throw Error('Method "'+a[c]+'" does not exist');var b=c.match(C),e=b[1],b=b[2],d=g.bind(d,this),e=e+(".delegateEvents"+this.cid);""===b?this.$el.bind(e,d):this.$el.delegate(b,e,d)}}},undelegateEvents:function(){this.$el.unbind(".delegateEvents"+this.cid)},_configure:function(a){this.options&&(a=g.extend({},this.options,a));for(var c=0,d=w.length;c<d;c++){var b=w[c];a[b]&&(this[b]=a[b])}this.options=a},_ensureElement:function(){if(this.el)this.setElement(this.el,
!1);else{var a=o(this,"attributes")||{};if(this.id)a.id=this.id;if(this.className)a["class"]=this.className;this.setElement(this.make(this.tagName,a),!1)}}});p.extend=r.extend=u.extend=v.extend=function(a,c){var b=D(this,a,c);b.extend=this.extend;return b};var E={create:"POST",update:"PUT","delete":"DELETE",read:"GET"};e.sync=function(a,c,b){var f=E[a];b||(b={});var h={type:f,dataType:"json"};if(!b.url)h.url=o(c,"url")||t();if(!b.data&&c&&("create"==a||"update"==a))h.contentType="application/json",
h.data=JSON.stringify(c.toJSON());if(e.emulateJSON)h.contentType="application/x-www-form-urlencoded",h.data=h.data?{model:h.data}:{};if(e.emulateHTTP&&("PUT"===f||"DELETE"===f)){if(e.emulateJSON)h.data._method=f;h.type="POST";h.beforeSend=function(a){a.setRequestHeader("X-HTTP-Method-Override",f)}}if("GET"!==h.type&&!e.emulateJSON)h.processData=!1;return k.ajax(g.extend(h,b))};e.wrapError=function(a,c,b){return function(e,f){f=e===c?f:e;a?a(c,f,b):c.trigger("error",c,f,b)}};var x=function(){},D=function(a,
c,b){var e;e=c&&c.hasOwnProperty("constructor")?c.constructor:function(){a.apply(this,arguments)};g.extend(e,a);x.prototype=a.prototype;e.prototype=new x;c&&g.extend(e.prototype,c);b&&g.extend(e,b);e.prototype.constructor=e;e.__super__=a.prototype;return e},o=function(a,c){return!a||!a[c]?null:g.isFunction(a[c])?a[c]():a[c]},t=function(){throw Error('A "url" property or function must be specified');}}).call(this);_.namespace("Backbone",function(i){_.extend(i.View.prototype,{close:function(){this.trigger("close");this.remove();this.off()},on_close:function(b){var f=_.bind(function(){this.off(null,f);b.call(this)},this);this.on("close",f)}});_.extend(i.History.prototype,{compareUrlFragments:function(b,f){return b===f||decodeURIComponent(b)===decodeURIComponent(f)},checkUrl:function(){var b=this.getFragment();this.compareUrlFragments(b,this.fragment)&&this.iframe&&(b=this.getFragment(this.getHash(this.iframe)));
if(this.compareUrlFragments(b,this.fragment))return!1;this.iframe&&this.navigate(b);this.loadUrl()||this.loadUrl(this.getHash())}});_.extend(i.Collection.prototype,{findWhere:function(b){return this.find(function(f){f=f.pick(_.keys(b));return _.isEqual(b,f)})},reset:function(b,f){b||(b=[]);f||(f={});for(var h=0,e=this.models.length;h<e;h++)this._removeReference(this.models[h]);f.previousModels=this.models;this._reset();this.add(b,_.extend({silent:!0},f));f.silent||this.trigger("reset",this,f);return this}});
_.extend(i.Model.prototype,{pick:function(){var b=Array.prototype.concat.apply([this.attributes],arguments);return _.pick.apply(_,b)}})});_.namespace("Backbone",function(i){function b(b){var h="";if(_.isFunction(b))return b;if("#"===b[0]){h=$(_.sprintf("%s[type='text/template']",b));if(0==h.length)throw Error("TemplateView: No template found with id = "+b);if(1<h.length)throw Error("TemplateView: More than one template found with id = "+b);h=h.text()}else h=b;return _.template(h,null,{variable:"d"})}i.TemplateView=i.View.extend({constructor:function(){var f=this.constructor.prototype;_.each(f.templates,function(h,e){_.isString(h)&&
(f.templates[e]=b(h))});i.View.prototype.constructor.apply(this,arguments)},helpers:{ensure_absolute_url:function(b){return-1==b.indexOf("://")?"http://"+b:b}},templates:{urlize:'<% if (mp.utility.isURL(d.raw_string)) { %>   <a href="<%- d.ensure_absolute_url(d.raw_string) %>"><%- d.formatted_string || d.raw_string %></a><% } else { %>   <%- d.formatted_string || d.raw_string %><% } %>'},recompile_templates:function(){_.each(this.templates,function(f,h){_.isString(f)&&(this.templates[h]=b(f))},this)},
render_base_template:function(b){this.$el.html(this.render_template("base",b))},render_template:function(b,h){var e=_.isUndefined(this.model)?{}:this.model.toJSON(),e=_.extend({model:e,_model:this.model,partial:this.partial_helper(h)},this.helpers,h);return this.templates[b](e)},partial_helper:function(b){return _.bind(function(h,e){return this.render_template(h,_.extend(b,e))},this)}})});_.namespace("Backbone",function(i){i.Widget=i.TemplateView.extend({show:function(){this.$el.show()},hide:function(){this.$el.hide()}})});_.namespace("Backbone",function(){var i=/:\w+/g,b=/\*\w+/g,f=/[-[\]{}()+.,\\^$|#\s]/g,h=/:rison/g;return{ViewRouter:Backbone.Router.extend({constructor:function(){mp.report&&mp.report.globals&&mp.report.globals.persistence&&this._load_persistence();Backbone.Router.prototype.constructor.apply(this,arguments)},navigate:function(b,g){this.persistence&&this.allow_persistence(b,g)&&this.persistence.run(null,"#"+b);Backbone.Router.prototype.navigate.apply(this,arguments)},route:function(b,g,f){var h=void 0;
_.isUndefined(f)||(h=function(){var b=f.apply(this,arguments);b&&this._change_page(g,b)});return Backbone.Router.prototype.route.call(this,b,g,h)},allow_persistence:function(){return!0},_load_persistence:function(){this.persistence=mp.report.globals.persistence;if(!document.location.hash&&"#"!=window.location.href.substr(-1))hash=this.persistence.path_to_hash(this.persistence.get_pathname()),window.location.hash=hash},_change_page:function(b,f){if(!this.session)throw"Must define 'session' variable on ViewRouter";
if(!this.render_target)throw"Must define 'render_target' variable on ViewRouter";this.current_view&&this.current_view.close();this.session.set(_.extend({page:b},f.session));this.current_view=new f.view;this.render_target.html(this.current_view.el);this._load_rison(f.rison);this.current_view.trigger("ready")},_load_rison:function(b){b&&(b=this._decode_rison(b))&&this.current_view.update_params(b);this.current_view.on("serialize_params",function(b,e){var f=this._encode_rison(e);this.navigate(b+"/"+
f)},this)},_decode_rison:function(b){return!b?{}:RISON.urldecode(_.sprintf("(%s)",b))},_encode_rison:function(b){b=RISON.urlencode(b);return b.substring(1,b.length-1)},_routeToRegExp:function(e){e=e.replace(f,"\\$&").replace(h,"(?:/([^/]+))?").replace(i,"([^/]+)").replace(b,"(.*?)");return RegExp("^"+e+"$")}})}});_.namespace("Backbone",function(i){i.Form=i.TemplateView.extend({events:{"submit form":"_handle_submit","click .cancel":"_handle_cancel"},form:[],templates:{tooltip:'<div class="tooltip"><div class="arrow"></div><%= d.error %></div>'},initialize:function(){_.has(this.templates,"base")||mp.utility.error("Backbone.Form requires you to define a base template");this._fired=!1;this.render_base_template(this.options);this.render();this.$el.addClass("backbone_form");var b=this.$("form").length;0==b?mp.utility.error("Backbone.Form requires you to have a form element in your base template"):
1<b&&mp.utility.error("Backbone.Form requires you to have only one form element in your base template")},reset:function(){this.remove_tooltip();this.$("form").get(0).reset();this.reenable()},reenable:function(){this._fired=!1},_handle_cancel:function(){this.trigger("cancel")},_handle_submit:function(b){b.preventDefault();if(!this._fired)this._fired=!0,this._save();return!1},_save:function(){var b=this._get_form_data(),f=this._validate(b);f&&0<f.length?(this.trigger("validation_error",f),this.options.disable_tooltips||
(this.show_tooltip(f[0]),this.reenable())):(this.loading_state(),this.make_request(b))},_get_form_data:function(){return _.map(this.form,function(b){if(_.isString(b))return b=this.$(b),{el:b,val:b.val(),nice_name:b.attr("title"),name:b.attr("name")};b=_.clone(b);b.val||mp.utility.error("Backbone.Form: objects in the forms variable must have a method `val()`");b.val=b.val.call(this);if(b.selector)b.el=this.$(b.selector);return b},this)},_validate:function(b){return _(b).chain().map(function(f){return _.extend({},
f,{error:this.validate_element(f,b)})},this).filter(function(b){return b.error}).value()},validate_element:function(b){if(_.isUndefined(b.val)||_.isString(b.val)&&0==b.val.length)return _.sprintf("%s is required.",b.nice_name)},make_request:function(b){var f={};_.each(b,function(b){f[b.name]=b.val});$.ajax(this.endpoint,{type:"POST",dataType:"json",data:f,error:_.bind(function(b,e,f){this.trigger_error(f)},this),success:_.bind(this.trigger_success,this)})},trigger_error:function(b){this.remove_tooltip();
this.loaded_state();this.trigger("error",b)},trigger_success:function(b){this.remove_tooltip();this.loaded_state();this.server_response_success(b)?this.trigger("save",this.parse_server_success(b)):this.trigger("error",this.parse_server_error(b))},server_response_success:function(b){return _.has(b,"success")&&b.success||_.has(b,"error")&&0==b.error.length},parse_server_error:function(b){return b.message||b.error},parse_server_success:function(b){return b.message},show_tooltip:function(b){this.remove_tooltip();
this.current_tooltip=$(this.render_template("tooltip",b));if(b.el){var f=b.el.position();this.current_tooltip.css({top:f.top+b.el.outerHeight(),left:f.left+10});f=b.el.outerWidth();100>f&&this.current_tooltip.find(".arrow").css({left:f/2-15});b.el.parent().append(this.current_tooltip)}},remove_tooltip:function(){this.current_tooltip&&this.current_tooltip.remove()}})});

//# sourceMappingURL=/site_media/bundle/backbone.min.js.map
